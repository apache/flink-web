---
title: "Apache Flinkとは? — 運用"
---

<hr/>


Apache Flink は、非有界および、有界のデータストリーム上でのステートフルな計算のためのフレームワークです。多くのストリーミングアプリケーションは、ダウンタイムを最小限に抑えて継続的に実行するように設計されているため、ストリームプロセッサは、優れた障害回復機能と、実行中のアプリケーションを監視・保守するためのツールを提供しなければなりません。

Apache Flink はストリーム処理の運用面に重点を置いています。ここでは、Flink の障害回復メカニズムを説明し、実行中のアプリケーションを管理・監督するための機能を紹介します。

## アプリケーションを無停止で24時間365日実行する

マシンやプロセスの障害は、分散システムではどこにでも存在します。Flinkのような分散ストリームプロセッサは、24時間365日ストリーミングアプリケーションを実行できるようにするために、障害から回復しなければなりません。明らかに、これは障害後にアプリケーションを再起動することだけを意味するのではなく、障害が発生しなかったかのようにアプリケーションが処理を続けることができるように、アプリケーションの内部状態が一貫していることを保証することを意味します。

Flinkは、アプリケーションの稼働を維持し、一貫性を保つためのいくつかの機能を提供しています。

* **一貫性のあるチェックポイント**。Flink の回復メカニズムは、アプリケーションの状態の一貫したチェックポイントに基づいています。障害が発生した場合、アプリケーションは再起動され、その状態は最新のチェックポイントからロードされます。リセット可能なストリームソースと組み合わせることで、この機能は*一度きりの状態の一貫性*を保証することができます。
* **効率的なチェックポイント**。アプリケーションの状態をチェックポイントするのは、アプリケーションがテラバイトの状態を維持している場合、かなりのコストがかかります。Flinkは非同期チェックポイントとインクリメンタルチェックポイントを実行することができ、アプリケーションの遅延SLAに与えるチェックポイントの影響を非常に小さく抑えることができます。
* **エンド・ツー・エンドの正確な一度きり**。Flinkは特定のストレージシステム用のトランザクションシンクを備えており、障害が発生した場合でも、データが正確に一度だけ書き出されることを保証します。
* **クラスタマネージャとの統合**。Flinkは、[Hadoop YARN](https://hadoop.apache.org)、[Mesos](https://mesos.apache.org)、[Kubernetes](https://kubernetes.io)などのクラスタマネージャと緊密に統合されています。プロセスが障害を起こした場合、新しいプロセスが自動的に開始され、その作業を引き継ぎます。
* **高可用性セットアップ**。Flinkは、単一障害点を排除した高可用性モードを特徴としています。高可用性モードは、信頼性の高い分散コーディネーションのための実績あるサービスである[Apache ZooKeeper](https://zookeeper.apache.org)をベースにしています。

## アプリケーションの更新・移行・一時停止・再開

ビジネスに不可欠なサービスを支えるストリーミング・アプリケーションは、メンテナンスが必要です。バグを修正し、改善や新機能を実装する必要があります。しかし、ステートフル・ストリーミング・アプリケーションを更新することは些細なことではありません。アプリケーションの状態を失うわけにはいかないので、アプリケーションを停止して、修正版や改良版を再起動することはできないことが多いのです。

Flinkの*Savepoints*は、ステートフルなアプリケーションの更新やその他多くの関連する課題を解決するユニークで強力な機能です。セーブポイントはアプリケーションの状態の一貫したスナップショットであり、チェックポイントに非常に似ています。しかし、チェックポイントとは対照的に、セーブポイントは手動でトリガーする必要があり、アプリケーションが停止したときに自動的に削除されることはありません。セーブポイントは、状態互換性のあるアプリケーションを起動し、その状態を初期化するために使用できます。セーブポイントを使用すると、以下の機能が有効になります。

* **アプリケーションの進化**。セーブポイントを使用してアプリケーションを進化させることができます。アプリケーションの修正版または改良版は、以前のバージョンのアプリケーションから取得したセーブポイントから再起動することができます。また、欠陥のあるバージョンによって生成された不正確な結果を修復するために、以前の時点からアプリケーションを起動することも可能です（そのようなセーブポイントが存在する場合）。
* **クラスタ移行**。セーブポイントを使用して、アプリケーションを異なるクラスタに移行（またはクローン化）することができます。
* **Flink のバージョン更新**。セーブポイントを使用して、アプリケーションを新しいFlinkバージョンで実行するように移行することができます。
* **アプリケーションのスケーリング**。Savepoints は、アプリケーションの並列性を増減させるために使用できます。
* **A/BテストとWhat-Ifシナリオ**。同じセーブポイントからすべてのバージョンを起動することで、アプリケーションの2つ（またはそれ以上）の異なるバージョンのパフォーマンスや品質を比較することができます。
* **一時停止と再開**。アプリケーションは、セーブポイントを取得して停止することで一時停止することができます。後日、任意の時点で、セーブポイントからアプリケーションを再開することができます。
* **アーカイブ**。Savepoints は、アプリケーションの状態を以前の時点にリセットできるようにアーカイブすることができます。

## アプリケーションの監視と制御

他のサービスと同様に、継続的に実行されているストリーミング・アプリケーションは、監視され、組織の運用インフラストラクチャ、すなわちモニタリングとロギング・サービスに統合される必要があります。モニタリングは、問題を予測し、事前に対応するのに役立ちます。ロギングは、障害を調査するための根本原因分析を可能にします。最後に、実行中のアプリケーションを制御するための簡単にアクセスできるインターフェースは重要な機能です。

Flinkは、多くの一般的なロギングおよびモニタリングサービスとうまく統合され、アプリケーションやクエリ情報を制御するためのREST APIを提供します。

* **Web UI**。Flinkは、実行中のアプリケーションを検査、監視、デバッグするためのWeb UIを備えています。また、実行のために実行を送信したり、実行をキャンセルしたりするために使用することもできます。
* **ロギング**. Flink は人気のある slf4j ロギングインターフェースを実装し、ロギングフレームワーク [log4j](https://logging.apache.org/log4j/2.x/) や [logback](https://logback.qos.ch/) と統合しています。
* **メトリクス**. Flink は、システムおよびユーザー定義のメトリクスを収集してレポートするための高度なメトリクスシステムを備えています。メトリクスは、[JMX](https://en.wikipedia.org/wiki/Java_Management_Extensions)、Ganglia、[Graphite](https://graphiteapp.org/)、[Prometheus](https://prometheus.io/)、[StatsD](https://github.com/etsy/statsd)、[Datadog](https://www.datadoghq.com/)、[Slf4j](https://www.slf4j.org/)などの複数のレポーターにエクスポートすることができます。
* **REST API**です。Flinkは、新規アプリケーションの送信、実行中のアプリケーションのセーブポイントの取得、アプリケーションのキャンセルを行うためのREST APIを公開しています。また、REST API は、実行中または完了したアプリケーションのメタデータと収集されたメトリクスも公開します。

<hr/>
<div class="row">
  <div class="col-sm-12" style="background-color: #f8f8f8;">
    <h2>
      <a href="{{ site.baseurl }}/jp/flink-architecture.html">アーキテクチャ</a> &nbsp;
      <span class="glyphicon glyphicon-chevron-right"></span> &nbsp;
      <a href="{{ site.baseurl }}/jp/flink-applications.html">アプリケーション</a> &nbsp;
      <span class="glyphicon glyphicon-chevron-right"></span> &nbsp;
      運用
    </h2>
  </div>
</div>
<hr/>
