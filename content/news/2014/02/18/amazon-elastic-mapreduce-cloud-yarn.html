<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink: Use Stratosphere with Amazon Elastic MapReduce</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/flink.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Blog RSS feed -->
    <link href="/blog/feed.xml" rel="alternate" type="application/rss+xml" title="Apache Flink Blog: RSS feed" />

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- We need to load Jquery in the header for custom google analytics event tracking-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>  
    

  <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/">
              <img alt="Apache Flink" src="/img/navbar-brand-logo.jpg" width="78px" height="40px">
            </a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">

            <!-- Overview -->
            <li><a href="/index.html">Overview</a></li>

            <!-- Features -->
            <li><a href="/features.html">Features</a></li>

            <!-- Downloads -->
            <li><a href="/downloads.html">Downloads</a></li>

            <!-- FAQ -->
            <li><a href="/faq.html">FAQ</a></li>


            <!-- Quickstart -->
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><small><span class="glyphicon glyphicon-new-window"></span></small> Quickstart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/quickstart/setup_quickstart.html">Setup</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/quickstart/java_api_quickstart.html">Java API</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/quickstart/scala_api_quickstart.html">Scala API</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/quickstart/run_example_quickstart.html">Run Step-by-Step Example</a></li>
              </ul>
            </li>


            <!-- Documentation -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><small><span class="glyphicon glyphicon-new-window"></span></small> Documentation <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <!-- Latest stable release -->
                <li role="presentation" class="dropdown-header"><strong>Latest Release</strong> (Stable)</li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0">1.0 Documentation</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/api/java" class="active">1.0 Javadocs</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0/api/scala/index.html" class="active">1.0 ScalaDocs</a></li>

                <!-- Snapshot docs -->
                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>Snapshot</strong> (Development)</li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-master">1.1 Documentation</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-master/api/java" class="active">1.1 Javadocs</a></li>
                <li><a href="http://ci.apache.org/projects/flink/flink-docs-master/api/scala/index.html" class="active">1.1 ScalaDocs</a></li>

                <!-- Wiki -->
                <li class="divider"></li>
                <li><a href="/visualizer/"><small><span class="glyphicon glyphicon-new-window"></span></small> Plan Visualizer</a></li>
                <li><a href="https://cwiki.apache.org/confluence/display/FLINK/Apache+Flink+Home"><small><span class="glyphicon glyphicon-new-window"></span></small> Wiki</a></li>
              </ul>
            </li>

          </ul>

          <ul class="nav navbar-nav navbar-right">
            <!-- Blog -->
            <li class=" active hidden-md hidden-sm"><a href="/blog/">Blog</a></li>

            <li class="dropdown hidden-md hidden-sm">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Community <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <!-- Community -->
                <li role="presentation" class="dropdown-header"><strong>Community</strong></li>
                <li><a href="/community.html#mailing-lists">Mailing Lists</a></li>
                <li><a href="/community.html#irc">IRC</a></li>
                <li><a href="/community.html#stack-overflow">Stack Overflow</a></li>
                <li><a href="/community.html#issue-tracker">Issue Tracker</a></li>
                <li><a href="/community.html#third-party-packages">Third Party Packages</a></li>
                <li><a href="/community.html#source-code">Source Code</a></li>
                <li><a href="/community.html#people">People</a></li>
                <li><a href="https://cwiki.apache.org/confluence/display/FLINK/Powered+by+Flink"><small><span class="glyphicon glyphicon-new-window"></span></small> Powered by Flink</a></li>

                <!-- Contribute -->
                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="/how-to-contribute.html">How to Contribute</a></li>
                <li><a href="/contribute-code.html">Contribute Code</a></li>
                <li><a href="/contribute-documentation.html">Contribute Documentation</a></li>
                <li><a href="/improve-website.html">Improve the Website</a></li>
              </ul>
            </li>

            <li class="dropdown hidden-md hidden-sm">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Project <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <!-- Project -->
                <li role="presentation" class="dropdown-header"><strong>Project</strong></li>
                <li><a href="/material.html">Material</a></li>
                <li><a href="https://twitter.com/apacheflink"><small><span class="glyphicon glyphicon-new-window"></span></small> Twitter</a></li>
                <li><a href="https://github.com/apache/flink"><small><span class="glyphicon glyphicon-new-window"></span></small> GitHub</a></li>
                <li><a href="https://cwiki.apache.org/confluence/display/FLINK/Apache+Flink+Home"><small><span class="glyphicon glyphicon-new-window"></span></small> Wiki</a></li>
              </ul>
            </li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    <!-- Main content. -->
    <div class="container">
      

<div class="row">
  <div class="col-sm-8 col-sm-offset-2">
    <div class="row">
      <h1>Use Stratosphere with Amazon Elastic MapReduce</h1>

      <article>
        <p>18 Feb 2014 by Robert Metzger (<a href="https://twitter.com/rmetzger_">@rmetzger_</a>)</p>

<div class="lead">Get started with Stratosphere within 10 minutes using Amazon Elastic MapReduce.</div>

<p>This step-by-step tutorial will guide you through the setup of Stratosphere using Amazon Elastic MapReduce.</p>

<h3 id="background">Background</h3>
<p><a href="http://aws.amazon.com/elasticmapreduce/">Amazon Elastic MapReduce</a> (Amazon EMR) is part of Amazon Web services. EMR allows to create Hadoop clusters that analyze data stored in Amazon S3 (AWS’ cloud storage). Stratosphere runs on top of Hadoop using the <a href="http://hadoop.apache.org/docs/r2.2.0/hadoop-project-dist/hadoop-common/releasenotes.html">recently</a> released cluster resource manager <a href="http://hadoop.apache.org/docs/current2/hadoop-yarn/hadoop-yarn-site/YARN.html">YARN</a>. YARN allows to use many different data analysis tools in your cluster side by side. Tools that run with YARN are, for example <a href="https://giraph.apache.org/">Apache Giraph</a>, <a href="http://spark.incubator.apache.org/">Spark</a> or <a href="http://hortonworks.com/blog/introducing-hoya-hbase-on-yarn/">HBase</a>. Stratosphere also <a href="/docs/0.4/setup/yarn.html">runs on YARN</a> and that’s the approach for this tutorial.</p>

<h3 id="step-login-to-aws-and-prepare-secure-access">1. Step: Login to AWS and prepare secure access</h3>

<ul>
  <li>Log in to the <a href="https://console.aws.amazon.com/console/home">AWS Console</a></li>
</ul>

<p>You need to have SSH keys to access the Hadoop master node. If you do not have keys for your computer, generate them:</p>

<div class="row" style="padding-top:15px">
	<div class="col-md-6">
<a data-lightbox="example-1" href="/img/blog/emr-security.png"><img class="img-responsive" src="/img/blog/emr-security.png" /></a>
	</div>
	<div class="col-md-6">
		<ul>
			<li>Select <a href="https://console.aws.amazon.com/ec2/v2/home">EC2</a> and click on "Key Pairs" in the "NETWORK &amp; SECURITY" section.</li>
			<li>Click on "Create Key Pair" and give it a name</li>
			<li>After pressing "Yes" it will download a .pem file.</li>
			<li>Change the permissions of the .pem file</li>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">chmod og-rwx ~/work-laptop.pem</code></pre></div>

		</ul>
	</div>
</div>

<h3 id="step-create-your-hadoop-cluster-in-the-cloud">2. Step: Create your Hadoop Cluster in the cloud</h3>

<ul>
  <li>Select <a href="https://console.aws.amazon.com/elasticmapreduce/vnext/">Elastic MapReduce</a> from the AWS console</li>
  <li>Click the blue “Create cluster” button.</li>
</ul>

<div class="row" style="padding-top:15px">
	<div class="col-md-6">
<a data-lightbox="example-1" href="/img/blog/emr-hadoopversion.png"><img class="img-responsive" src="/img/blog/emr-hadoopversion.png" /></a>
	</div>
	<div class="col-md-6">
		<ul>
			<li>Choose a Cluster name</li>
			<li>You can let the other settings remain unchanged (termination protection, logging, debugging)</li>
			<li>For the Hadoop distribution, it is very important to choose one with YARN support. We use <b>3.0.3 (Hadoop 2.2.0)</b> (the minor version might change over time)</li>
			<li>Remove all applications to be installed (unless you want to use them)</li>
			<li>Choose the instance types you want to start. Stratosphere runs fine with m1.large instances. Core and Task instances both run Stratosphere, but only core instances contain HDFS data nodes.</li>
			<li>Choose the <b>EC2 key pair</b> you've created in the previous step!</li>
		</ul>
	</div>
</div>

<ul>
  <li>Thats it! You can now press the “Create cluster” button at the end of the form to boot it!</li>
</ul>

<h3 id="step-launch-stratosphere">3. Step: Launch Stratosphere</h3>

<p>You might need to wait a few minutes until Amazon started your cluster. (You can monitor the progress of the instances in EC2). Use the refresh button in the top right corner.</p>

<p>You see that the master is up if the field <b>Master public DNS</b> contains a value (first line), connect to it using SSH.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">ssh hadoop@&lt;your master public DNS&gt; -i &lt;path to your .pem&gt;
<span class="c"># for my example, it looks like this:</span>
ssh hadoop@ec2-54-213-61-105.us-west-2.compute.amazonaws.com -i ~/Downloads/work-laptop.pem</code></pre></div>

<p>(Windows users have to follow <a href="http://docs.aws.amazon.com/ElasticMapReduce/latest/DeveloperGuide/emr-connect-master-node-ssh.html">these instructions</a> to SSH into the machine running the master.) &lt;/br&gt;&lt;/br&gt;
Once connected to the master, download and start Stratosphere for YARN:</p>
<ul>
	<li>Download and extract Stratosphere-YARN</li>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">wget http://stratosphere-bin.s3-website-us-east-1.amazonaws.com/stratosphere-dist-0.5-SNAPSHOT-yarn.tar.gz
<span class="c"># extract it</span>
tar xvzf stratosphere-dist-0.5-SNAPSHOT-yarn.tar.gz</code></pre></div>

	<li>Start Stratosphere in the cluster using Hadoop YARN</li>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>stratosphere-yarn-0.5-SNAPSHOT/
./bin/yarn-session.sh -n <span class="m">4</span> -jm <span class="m">1024</span> -tm 3000</code></pre></div>


The arguments have the following meaning
	<ul>
			<li><code>-n</code> number of TaskManagers (=workers). This number must not exeed the number of task instances</li>
			<li><code>-jm</code> memory (heapspace) for the JobManager</li>
			<li><code>-tm</code> memory for the TaskManagers</li>
	</ul>
</ul>

<p>Once the output has changed from</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">JobManager is now running on N/A:6123</code></pre></div>

<p>to</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">JobManager is now running on ip-172-31-13-68.us-west-2.compute.internal:6123</code></pre></div>

<p>Stratosphere has started the JobManager. It will take a few seconds until the TaskManagers (workers) have connected to the JobManager. To see how many TaskManagers connected, you have to access the JobManager’s web interface. Follow the steps below to do that …</p>

<h3> 4. Step: Launch a Stratosphere Job</h3>

<p>This step shows how to submit and monitor a Stratosphere Job in the Amazon Cloud.</p>

<ul>
<li> Open an additional terminal and connect again to the master of your cluster. </li>

We recommend to create a SOCKS-proxy with your SSH that allows you to easily connect into the cluster. (If you've already a VPN setup with EC2, you can probably use that as well.)


<div class="highlight"><pre><code class="language-bash" data-lang="bash">ssh -D localhost:2001 hadoop@&lt;your master dns name&gt; -i &lt;your pem file&gt;</code></pre></div>


Notice the <code>-D localhost:2001</code> argument: It opens a SOCKS proxy on your computer allowing any application to use it to communicate through the proxy via an SSH tunnel to the master node. This allows you to access all services in your EMR cluster, such as the HDFS NameNode or the YARN web interface.

<li>Configure a browser to use the SOCKS proxy. Open a browser with SOCKS proxy support (such as Firefox). Ideally, do not use your primary browser for this, since ALL traffic will be routed through Amazon.</li>

<div class="row" style="padding-top:15px">
	<div class="col-md-6">
<a data-lightbox="example-1" href="/img/blog/emr-firefoxsettings.png"><img class="img-responsive" src="/img/blog/emr-firefoxsettings.png" /></a>
	</div>
	<div class="col-md-6">
		<ul>
			<li>To configure the SOCKS proxy with Firefox, click on "Edit", "Preferences", choose the "Advanced" tab and press the "Settings ..." button.</li>
			<li>Enter the details of the SOCKS proxy <b>localhost:2001</b>. Choose SOCKS v4.</li>
			<li>Close the settings, your browser is now talking to the master node of your cluster</li>
		</ul>
	</div>
</div>

</ul>

<p>Since you’re connected to the master now, you can open several web interfaces: <br />
<b>YARN Resource Manager</b>: <code>http://&lt;masterIPAddress&gt;:9026/</code> <br />
<b>HDFS NameNode</b>: <code>http://&lt;masterIPAddress&gt;:9101/</code></p>

<p>You find the <code>masterIPAddress</code> by entering <code>ifconfig</code> into the terminal:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>hadoop@ip-172-31-38-95 ~<span class="o">]</span><span class="nv">$ </span>ifconfig
eth0      Link encap:Ethernet  HWaddr 02:CF:8E:CB:28:B2  
          inet addr:172.31.38.95  Bcast:172.31.47.255  Mask:255.255.240.0
          inet6 addr: fe80::cf:8eff:fecb:28b2/64 Scope:Link
          RX bytes:166314967 <span class="o">(</span>158.6 MiB<span class="o">)</span>  TX bytes:89319246 <span class="o">(</span>85.1 MiB<span class="o">)</span></code></pre></div>

<p><strong>Optional:</strong> If you want to use the hostnames within your Firefox (that also makes the NameNode links work), you have to enable DNS resolution over the SOCKS proxy. Open the Firefox config <code>about:config</code> and set <code>network.proxy.socks_remote_dns</code> to <code>true</code>.</p>

<p>The YARN ResourceManager also allows you to connect to <b>Stratosphere’s JobManager web interface</b>. Click the <b>ApplicationMaster</b> link in the “Tracking UI” column.</p>

<p>To run the Wordcount example, you have to upload some sample data.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># download a text</span>
wget http://www.gnu.org/licenses/gpl.txt
<span class="c"># upload it to HDFS:</span>
hadoop fs -copyFromLocal gpl.txt /input</code></pre></div>

<p>To run a Job, enter the following command into the master’s command line:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># optional: go to the extracted directory</span>
<span class="nb">cd </span>stratosphere-yarn-0.5-SNAPSHOT/
<span class="c"># run the wordcount example</span>
./bin/stratosphere run -w -j examples/stratosphere-java-examples-0.5-SNAPSHOT-WordCount.jar  -a <span class="m">16</span> hdfs:///input hdfs:///output</code></pre></div>

<p>Make sure that the number of TaskManager’s have connected to the JobManager.</p>

<p>Lets go through the command in detail:</p>

<ul>
  <li><code>./bin/stratosphere</code> is the standard launcher for Stratosphere jobs from the command line</li>
  <li>The <code>-w</code> flag stands for “wait”. It is a very useful to track the progress of the job.</li>
  <li><code>-j examples/stratosphere-java-examples-0.5-SNAPSHOT-WordCount.jar</code> the <code>-j</code> command sets the jar file containing the job. If you have you own application, place your Jar-file here.</li>
  <li><code>-a 16 hdfs:///input hdfs:///output</code> the <code>-a</code> command specifies the Job-specific arguments. In this case, the wordcount expects the following input <code>&lt;numSubStasks&gt; &lt;input&gt; &lt;output&gt;</code>.</li>
</ul>

<p>You can monitor the progress of your job in the JobManager webinterface. Once the job has finished (which should be the case after less than 10 seconds), you can analyze it there.
Inspect the result in HDFS using:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">hadoop fs -tail /output</code></pre></div>

<p>If you want to shut down the whole cluster in the cloud, use Amazon’s webinterface and click on “Terminate cluster”. If you just want to stop the YARN session, press CTRL+C in the terminal. The Stratosphere instances will be killed by YARN.</p>

      </article>
    </div>

    <div class="row">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'stratosphere-eu'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
  </div>
</div>

      <hr />
      <div class="footer text-center">
        <p>Copyright © 2014-2015 <a href="http://apache.org">The Apache Software Foundation</a>. All Rights Reserved.</p>
        <p>Apache Flink, Apache, and the Apache feather logo are trademarks of The Apache Software Foundation.</p>
        <p><a href="/privacy-policy.html">Privacy Policy</a> &middot; <a href="/blog/feed.xml">RSS feed</a></p>
      </div>

    </div><!-- /.container -->

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/js/codetabs.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
