
<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta name="generator" content="Hugo 0.113.0">
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Apache Flink 1.11 has released many exciting new features, including many developments in Flink SQL which is evolving at a fast pace. This article takes a closer look at how to quickly build streaming applications with Flink SQL from a practical point of view.
In the following sections, we describe how to integrate Kafka, MySQL, Elasticsearch, and Kibana with Flink SQL to analyze e-commerce user behavior in real-time. All exercises in this blogpost are performed in the Flink SQL CLI, and the entire process uses standard SQL syntax, without a single line of Java/Scala code or IDE installation.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Flink SQL Demo: Building an End-to-End Streaming Application" />
<meta property="og:description" content="Apache Flink 1.11 has released many exciting new features, including many developments in Flink SQL which is evolving at a fast pace. This article takes a closer look at how to quickly build streaming applications with Flink SQL from a practical point of view.
In the following sections, we describe how to integrate Kafka, MySQL, Elasticsearch, and Kibana with Flink SQL to analyze e-commerce user behavior in real-time. All exercises in this blogpost are performed in the Flink SQL CLI, and the entire process uses standard SQL syntax, without a single line of Java/Scala code or IDE installation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://flink.apache.org/2020/07/28/flink-sql-demo-building-an-end-to-end-streaming-application/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-28T12:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-28T12:00:00+00:00" />
<title>Flink SQL Demo: Building an End-to-End Streaming Application | Apache Flink</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e3b33391dbc1f4b2cc47778e2f4b86c744ded3ccc82fdfb6f08caf91d8607f9a.css" integrity="sha256-47MzkdvB9LLMR3eOL0uGx0Te08zIL9&#43;28Iyvkdhgf5o=">
<script defer src="/en.search.min.8592fd2e43835d2ef6fab8eb9b8969ee6ad1bdb888a636e37e28032f8bd9887d.js" integrity="sha256-hZL9LkODXS72&#43;rjrm4lp7mrRvbiIpjbjfigDL4vZiH0="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  

<link rel="stylesheet" type="text/css" href="/font-awesome/css/font-awesome.min.css">
<script src="/js/anchor.min.js"></script>
<script src="/js/flink.js"></script>
<link rel="canonical" href="https://flink.apache.org/2020/07/28/flink-sql-demo-building-an-end-to-end-streaming-application/">

    
    <script>
      var _paq = window._paq = window._paq || [];
       
       
      _paq.push(['disableCookies']);
       
      _paq.push(["setDomains", ["*.flink.apache.org","*.nightlies.apache.org/flink"]]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  

<nav>


<a id="logo" href="/">
    <img width="70%" src="/flink-header-logo.svg">
</a>

<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>










  





  
    
  
    
  
  

  <input type="checkbox" id="section-4117fb24454a2c30ee86e524839e77ec" class="toggle"  />
  <label for="section-4117fb24454a2c30ee86e524839e77ec" class="flex justify-between flink-menu-item">What is Apache Flink?<span>▾</span>
  </label>

    <ul>
    
      <li>
      
  

  
  
    <label for="section-ffd5922da551e96e0481423fab94c463" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/what-is-flink/flink-architecture/" class="">Architecture</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-fc28f08b67476edb77e00e03b6c7c2e0" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/what-is-flink/flink-applications/" class="">Applications</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-612df33a02d5d4ee78d718abaab5b5b4" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/what-is-flink/flink-operations/" class="">Operations</a>
    </label>
  

      </li>
    
    </ul>
  

  
    
  
    
  

  
  
    
    
    
<label for="section-f1ecec07350bd6810050d40158878749" class="flex justify-between flink-menu-item">
    <a href="https://nightlies.apache.org/flink/flink-statefun-docs-stable/" style="color:black" class="">What is Stateful Functions? <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

  

  
    
  
    
  

  
  
    
    
    
<label for="section-4113a4c3072cb35f6fd7a0d4e098ee70" class="flex justify-between flink-menu-item">
    <a href="https://nightlies.apache.org/flink/flink-ml-docs-stable/" style="color:black" class="">What is Flink ML? <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

  

  
    
  
    
  

  
  
    
    
    
<label for="section-b39c70259d0abbe2bf1d8d645425f84d" class="flex justify-between flink-menu-item">
    <a href="https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-stable/" style="color:black" class="">What is the Flink Kubernetes Operator? <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

  

  
    
  
    
  

  
  
    
    
    
<label for="section-53e0b1afcb9ccaf779dc285aa272a014" class="flex justify-between flink-menu-item">
    <a href="https://nightlies.apache.org/flink/flink-table-store-docs-stable/" style="color:black" class="">What is Flink Table Store? <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

  

  
    
  
    
  

  
  
    <label for="section-f4973f06a66f063045b4ebdacaf3127d" class="flex justify-between flink-menu-item">
    <a href="/use-cases/" class="">Use Cases</a>
    </label>
  

  

  
    
  
    
  

  
  
    <label for="section-0f1863835376e859ac438ae9529daff2" class="flex justify-between flink-menu-item">
    <a href="/powered-by/" class="">Powered By</a>
    </label>
  

  

  
  <br/>


  
    
  
    
  

  
  
    <label for="section-f383f23a96a43d8d0cc66aeb0237e26a" class="flex justify-between flink-menu-item">
    <a href="/downloads/" class="">Downloads</a>
    </label>
  

  

  
    
  
    
  
  

  <input type="checkbox" id="section-c727fab97b4d77e5b28ce8c448fb9000" class="toggle"  />
  <label for="section-c727fab97b4d77e5b28ce8c448fb9000" class="flex justify-between flink-menu-item">Getting Started<span>▾</span>
  </label>

    <ul>
    
      <li>
      
  

  
  
    
    
    
<label for="section-f45abaa99ab076108b9a5b94edbc6647" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/try-flink/local_installation/" style="color:black" class="">With Flink <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-efe2166e9dce6f72e126dcc2396b4402" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-statefun-docs-stable/getting-started/project-setup.html" style="color:black" class="">With Flink Stateful Functions <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-7e268d0a469b1093bb33d71d093eb7b9" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-ml-docs-stable/docs/try-flink-ml/quick-start/" style="color:black" class="">With Flink ML <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-cc7147cd0441503127bfaf6f219d4fbb" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-stable/docs/try-flink-kubernetes-operator/quick-start/" style="color:black" class="">With Flink Kubernetes Operator <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-660ca694e416d8ca9176dda52a60d637" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-table-store-docs-stable/docs/try-table-store/quick-start/" style="color:black" class="">With Flink Table Store <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-75db0b47bf4ae9c247aadbba5fbd720d" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/learn-flink/overview/" style="color:black" class="">Training Course <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
    </ul>
  

  
    
  
    
  
  

  <input type="checkbox" id="section-6318075fef29529089951a49d413d083" class="toggle"  />
  <label for="section-6318075fef29529089951a49d413d083" class="flex justify-between flink-menu-item">Documentation<span>▾</span>
  </label>

    <ul>
    
      <li>
      
  

  
  
    
    
    
<label for="section-9a8122d8912450484d1c25394ad40229" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-docs-stable/" style="color:black" class="">Flink 1.17 (stable) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-8b2fd3efb702be3783ba98d650707e3c" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-docs-master/" style="color:black" class="">Flink Master (snapshot) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-5317a079cddb964c59763c27607f43d9" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-statefun-docs-stable/" style="color:black" class="">Stateful Functions 3.2 (stable) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-25b72f108b7156e94d91b04853d8813a" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-statefun-docs-master" style="color:black" class="">Stateful Functions Master (snapshot) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-27ca02ef0fc9328fd4cb17a730bb50ab" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-ml-docs-stable/" style="color:black" class="">ML 2.3 (stable) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-6d895ec5ad127a29a6a9ce101328ccdf" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-ml-docs-master" style="color:black" class="">ML Master (snapshot) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-93ffa11271d7526865cf9a4c410cc9f1" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-stable/" style="color:black" class="">Kubernetes Operator 1.6 (latest) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-a2c75d90005425982ba8f26ae0e160a3" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-main" style="color:black" class="">Kubernetes Operator Main (snapshot) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-07b85e4b2f61b1526bf202c64460abcd" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-table-store-docs-stable/" style="color:black" class="">Table Store 0.3 (stable) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
      <li>
      
  

  
  
    
    
    
<label for="section-9b9a0032b1e858a34c125d828d1a0718" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="https://nightlies.apache.org/flink/flink-table-store-docs-master/" style="color:black" class="">Table Store Master (snapshot) <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

      </li>
    
    </ul>
  

  
    
  
    
  

  
  
    <label for="section-63d6a565d79aa2895f70806a46021c07" class="flex justify-between flink-menu-item">
    <a href="/getting-help/" class="">Getting Help</a>
    </label>
  

  

  
    
  
    
  

  
  
    
    
    
<label for="section-1d5066022b83f4732dc80f4e9eaa069a" class="flex justify-between flink-menu-item">
    <a href="https://flink-packages.org/" style="color:black" class="">flink-packages.org <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>
  

  

  
  <br/>


  
    
  
    
  

  
  
    <label for="section-7821b78a97db9e919426e86121a7be9c" class="flex justify-between flink-menu-item">
    <a href="/community/" class="">Community & Project Info</a>
    </label>
  

  

  
    
  
    
  

  
  
    <label for="section-8c042831df4e371c4ef9375f1df06f35" class="flex justify-between flink-menu-item">
    <a href="/roadmap/" class="">Roadmap</a>
    </label>
  

  

  
    
  
    
  
  

  <input type="checkbox" id="section-73117efde5302fddcb193307d582b588" class="toggle"  />
  <label for="section-73117efde5302fddcb193307d582b588" class="flex justify-between flink-menu-item">How to Contribute<span>▾</span>
  </label>

    <ul>
    
      <li>
      
  

  
  
    <label for="section-6646b26b23a3e79b8de9c552ee76f6dd" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/overview/" class="">Overview</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-e6ab9538b82cd5f94103b971adb7c1a9" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/contribute-code/" class="">Contribute Code</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-1c09e1358485e82d9b3f5f689d4ced65" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/reviewing-prs/" class="">Review Pull Requests</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-ed01e0defd235498fa3c9a2a0b3302fb" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/code-style-and-quality-preamble/" class="">Code Style and Quality Guide</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-4e8d5e9924cf15f397711b0d82e15650" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/contribute-documentation/" class="">Contribute Documentation</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-ddaa8307917e5ba7f60ba3316711e492" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/documentation-style-guide/" class="">Documentation Style Guide</a>
    </label>
  

      </li>
    
      <li>
      
  

  
  
    <label for="section-390a72c171cc82f180a308b95fc3aa72" class="flex justify-between flink-menu-item flink-menu-child">
    <a href="/how-to-contribute/improve-website/" class="">Contribute to the Website</a>
    </label>
  

      </li>
    
    </ul>
  

  
    
  
    
  

  
  
    <label for="section-9d3ddfd487223d5a199ba301f25c88c6" class="flex justify-between flink-menu-item">
    <a href="/security/" class="">Security</a>
    </label>
  

  

  
  <br/>



  
    
  

  
  
    <label for="section-a07783f405300745807d39eacf150420" class="flex justify-between flink-menu-item">
    <a href="/posts/" class="">Flink Blog</a>
    </label>
  

  

  




















<br/>
<hr class="menu-break">

  
<label for="section-f71a7070dbb7b669824a6441408ded70" class="flex justify-between flink-menu-item">
    <a href="https://github.com/apache/flink" style="color:black" class="">Flink on GitHub <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>

  
<label for="section-2ccaaab8c67f3105bbf7df75faca8027" class="flex justify-between flink-menu-item">
    <a href="https://twitter.com/apacheflink" style="color:black" class="">@ApacheFlink <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label>



<hr class="menu-break">
<table>
  <tr>
    <th colspan="2">
<label for="section-78c2028200542d78f8c1a8f6b4cbb36b" class="flex justify-between flink-menu-item">
    <a href="https://www.apache.org/" style="color:black" class="">Apache Software Foundation <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label></th>
  </tr>
  <tr>
    <td>
<label for="section-794df3791a8c800841516007427a2aa3" class="flex justify-between flink-menu-item">
    <a href="https://www.apache.org/licenses/" style="color:black" class="">License <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label></td>
    <td>
<label for="section-2fae32629d4ef4fc6341f1751b405e45" class="flex justify-between flink-menu-item">
    <a href="https://www.apache.org/security/" style="color:black" class="">Security <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label></td>
  </tr>
  <tr>
    <td>
<label for="section-0584e445d656b83b431227bb80ff0c30" class="flex justify-between flink-menu-item">
    <a href="https://www.apache.org/foundation/sponsorship.html" style="color:black" class="">Donate <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label></td>
    <td>
<label for="section-00d06796e489999226fb5bb27fe1b3b2" class="flex justify-between flink-menu-item">
    <a href="https://www.apache.org/foundation/thanks.html" style="color:black" class="">Thanks <i class="link fa fa-external-link title" aria-hidden="true"></i></a>
</label></td>
  </tr>
</table>

<hr class="menu-break">



  

  







<a  href="/zh/" class="flex align-center">
  <i class="fa fa-globe" aria-hidden="true"></i>&nbsp;&nbsp;
  中文版
</a>

<script src="/js/track-search-terms.js"></script>


</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Flink SQL Demo: Building an End-to-End Streaming Application</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    


<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#preparation">Preparation</a>
      <ul>
        <li><a href="#starting-the-demo-environment">Starting the Demo Environment</a></li>
        <li><a href="#entering-the-flink-sql-cli-client">Entering the Flink SQL CLI client</a></li>
        <li><a href="#creating-a-kafka-table-using-ddl">Creating a Kafka table using DDL</a></li>
      </ul>
    </li>
    <li><a href="#hourly-trading-volume">Hourly Trading Volume</a>
      <ul>
        <li><a href="#creating-an-elasticsearch-table-using-ddl">Creating an Elasticsearch table using DDL</a></li>
        <li><a href="#submitting-a-query">Submitting a Query</a></li>
        <li><a href="#using-kibana-to-visualize-results">Using Kibana to Visualize Results</a></li>
      </ul>
    </li>
    <li><a href="#cumulative-number-of-unique-visitors-every-10-min">Cumulative number of Unique Visitors every 10-min</a></li>
    <li><a href="#top-categories">Top Categories</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      




      
<article class="markdown">
    <h1>
        <a href="/2020/07/28/flink-sql-demo-building-an-end-to-end-streaming-application/">Flink SQL Demo: Building an End-to-End Streaming Application</a>
    </h1>
    
  July 28, 2020 -



  Jark Wu

  <a href="https://twitter.com/JarkWu">(@JarkWu)</a>
  



    <p><p>Apache Flink 1.11 has released many exciting new features, including many developments in Flink SQL which is evolving at a fast pace. This article takes a closer look at how to quickly build streaming applications with Flink SQL from a practical point of view.</p>
<p>In the following sections, we describe how to integrate Kafka, MySQL, Elasticsearch, and Kibana with Flink SQL to analyze e-commerce user behavior in real-time. All exercises in this blogpost are performed in the Flink SQL CLI, and the entire process uses standard SQL syntax, without a single line of Java/Scala code or IDE installation. The final result of this demo is shown in the following figure:</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image1.gif" width="650px" alt="Demo Overview"/>
</center>
<br>
<h1 id="preparation">
  Preparation
  <a class="anchor" href="#preparation">#</a>
</h1>
<p>Prepare a Linux or MacOS computer with Docker installed.</p>
<h2 id="starting-the-demo-environment">
  Starting the Demo Environment
  <a class="anchor" href="#starting-the-demo-environment">#</a>
</h2>
<p>The components required in this demo are all managed in containers, so we will use <code>docker-compose</code> to start them. First, download the <code>docker-compose.yml</code> file that defines the demo environment, for example by running the following commands:</p>
<pre tabindex="0"><code>mkdir flink-sql-demo; cd flink-sql-demo;
wget https://raw.githubusercontent.com/wuchong/flink-sql-demo/v1.11-EN/docker-compose.yml
</code></pre><p>The Docker Compose environment consists of the following containers:</p>
<ul>
<li><strong>Flink SQL CLI:</strong> used to submit queries and visualize their results.</li>
<li><strong>Flink Cluster:</strong> a Flink JobManager and a Flink TaskManager container to execute queries.</li>
<li><strong>MySQL:</strong> MySQL 5.7 and a pre-populated <code>category</code> table in the database. The <code>category</code> table will be joined with data in Kafka to enrich the real-time data.</li>
<li><strong>Kafka:</strong> mainly used as a data source. The DataGen component automatically writes data into a Kafka topic.</li>
<li><strong>Zookeeper:</strong> this component is required by Kafka.</li>
<li><strong>Elasticsearch:</strong> mainly used as a data sink.</li>
<li><strong>Kibana:</strong> used to visualize the data in Elasticsearch.</li>
<li><strong>DataGen:</strong> the data generator. After the container is started, user behavior data is automatically generated and sent to the Kafka topic. By default, 2000 data entries are generated each second for about 1.5 hours. You can modify DataGen&rsquo;s <code>speedup</code> parameter in <code>docker-compose.yml</code> to adjust the generation rate (which takes effect after Docker Compose is restarted).</li>
</ul>
<div class="alert alert-danger" markdown="1">
<span class="label label-danger" style="display: inline-block"> Note </span>
Before starting the containers, we recommend configuring Docker so that sufficient resources are available and the environment does not become unresponsive. We suggest running Docker at 3-4 GB memory and 3-4 CPU cores.
</div>
<p>To start all containers, run the following command in the directory that contains the <code>docker-compose.yml</code> file.</p>
<pre tabindex="0"><code>docker-compose up -d
</code></pre><p>This command automatically starts all the containers defined in the Docker Compose configuration in a detached mode. Run <code>docker ps</code> to check whether the 9 containers are running properly. You can also visit <a href="http://localhost:5601/">http://localhost:5601/</a> to see if Kibana is running normally.</p>
<p>Don’t forget to run the following command to stop all containers after you finished the tutorial:</p>
<pre tabindex="0"><code>docker-compose down
</code></pre><h2 id="entering-the-flink-sql-cli-client">
  Entering the Flink SQL CLI client
  <a class="anchor" href="#entering-the-flink-sql-cli-client">#</a>
</h2>
<p>To enter the SQL CLI client run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker-compose <span class="nb">exec</span> sql-client ./sql-client.sh
</span></span></code></pre></div><p>The command starts the SQL CLI client in the container.
You should see the welcome screen of the CLI client.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image3.png" width="500px" alt="Flink SQL CLI welcome page"/>
</center>
<br>
<h2 id="creating-a-kafka-table-using-ddl">
  Creating a Kafka table using DDL
  <a class="anchor" href="#creating-a-kafka-table-using-ddl">#</a>
</h2>
<p>The DataGen container continuously writes events into the Kafka <code>user_behavior</code> topic. This data contains the user behavior on the day of November 27, 2017 (behaviors include “click”, “like”, “purchase” and “add to shopping cart” events). Each row represents a user behavior event, with the user ID, product ID, product category ID, event type, and timestamp in JSON format. Note that the dataset is from the <a href="https://tianchi.aliyun.com/dataset/dataDetail?dataId=649">Alibaba Cloud Tianchi public dataset</a>.</p>
<p>In the directory that contains <code>docker-compose.yml</code>, run the following command to view the first 10 data entries generated in the Kafka topic:</p>
<pre tabindex="0"><code>docker-compose exec kafka bash -c &#39;kafka-console-consumer.sh --topic user_behavior --bootstrap-server kafka:9094 --from-beginning --max-messages 10&#39;

{&#34;user_id&#34;: &#34;952483&#34;, &#34;item_id&#34;:&#34;310884&#34;, &#34;category_id&#34;: &#34;4580532&#34;, &#34;behavior&#34;: &#34;pv&#34;, &#34;ts&#34;: &#34;2017-11-27T00:00:00Z&#34;}
{&#34;user_id&#34;: &#34;794777&#34;, &#34;item_id&#34;:&#34;5119439&#34;, &#34;category_id&#34;: &#34;982926&#34;, &#34;behavior&#34;: &#34;pv&#34;, &#34;ts&#34;: &#34;2017-11-27T00:00:00Z&#34;}
...
</code></pre><p>In order to make the events in the Kafka topic accessible to Flink SQL, we run the following DDL statement in SQL CLI to create a table that connects to the topic in the Kafka cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_behavior</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">category_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">behavior</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">proctime</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">PROCTIME</span><span class="p">(),</span><span class="w">   </span><span class="c1">-- generates processing-time attribute using computed column
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">WATERMARK</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="k">SECOND</span><span class="w">  </span><span class="c1">-- defines watermark on ts column, marks ts as event-time attribute
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;connector&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;kafka&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- using kafka connector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;topic&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user_behavior&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- kafka topic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;scan.startup.mode&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;earliest-offset&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- reading from the beginning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;properties.bootstrap.servers&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;kafka:9094&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- kafka broker address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;format&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="w">  </span><span class="c1">-- the data format is json
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>The above snippet declares five fields based on the data format. In addition, it uses the computed column syntax and built-in <code>PROCTIME()</code> function to declare a virtual column that generates the processing-time attribute. It also uses the <code>WATERMARK</code> syntax to declare the watermark strategy on the <code>ts</code> field (tolerate 5-seconds out-of-order). Therefore, the <code>ts</code> field becomes an event-time attribute. For more information about time attributes and DDL syntax, see the following official documents:</p>
<ul>
<li><a href="//nightlies.apache.org/flink/flink-docs-release-1.11/dev/table/streaming/time_attributes.html">Time attributes in Flink’s Table API &amp; SQL</a></li>
<li><a href="//nightlies.apache.org/flink/flink-docs-release-1.11/dev/table/sql/create.html#create-table">DDL Syntax in Flink SQL</a></li>
</ul>
<p>After creating the <code>user_behavior</code> table in the SQL CLI, run <code>SHOW TABLES;</code> and <code>DESCRIBE user_behavior;</code> to see registered tables and table details. Also, run the command <code>SELECT * FROM user_behavior;</code> directly in the SQL CLI to preview the data (press <code>q</code> to exit).</p>
<p>Next, we discover more about Flink SQL through three real-world scenarios.</p>
<h1 id="hourly-trading-volume">
  Hourly Trading Volume
  <a class="anchor" href="#hourly-trading-volume">#</a>
</h1>
<h2 id="creating-an-elasticsearch-table-using-ddl">
  Creating an Elasticsearch table using DDL
  <a class="anchor" href="#creating-an-elasticsearch-table-using-ddl">#</a>
</h2>
<p>Let’s create an Elasticsearch result table in the SQL CLI. We need two columns in this case: <code>hour_of_day</code> and <code>buy_cnt</code> (trading volume).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">buy_cnt_per_hour</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">hour_of_day</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">buy_cnt</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;connector&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">-- using elasticsearch connector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;hosts&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">-- elasticsearch address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="s1">&#39;index&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;buy_cnt_per_hour&#39;</span><span class="w">  </span><span class="c1">-- elasticsearch index name, similar to database table name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>There is no need to create the <code>buy_cnt_per_hour</code> index in Elasticsearch in advance since Elasticsearch will automatically create the index if it does not exist.</p>
<h2 id="submitting-a-query">
  Submitting a Query
  <a class="anchor" href="#submitting-a-query">#</a>
</h2>
<p>The hourly trading volume is the number of &ldquo;buy&rdquo; behaviors completed each hour. Therefore, we can use a <code>TUMBLE</code> window function to assign data into hourly windows. Then, we count the number of “buy” records in each window. To implement this, we can filter out the &ldquo;buy&rdquo; data first and then apply <code>COUNT(*)</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">buy_cnt_per_hour</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">HOUR</span><span class="p">(</span><span class="n">TUMBLE_START</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="n">HOUR</span><span class="p">)),</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">user_behavior</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;buy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">TUMBLE</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="n">HOUR</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>Here, we use the built-in <code>HOUR</code> function to extract the value for each hour in the day from a <code>TIMESTAMP</code> column. Use <code>INSERT INTO</code> to start a Flink SQL job that continuously writes results into the Elasticsearch <code>buy_cnt_per_hour</code> index. The Elasticearch result table can be seen as a materialized view of the query. You can find more information about Flink’s window aggregation in the <a href="//nightlies.apache.org/flink/flink-docs-release-1.11/dev/table/sql/queries.html#group-windows">Apache Flink documentation</a>.</p>
<p>After running the previous query in the Flink SQL CLI, we can observe the submitted task on the <a href="http://localhost:8081">Flink Web UI</a>. This task is a streaming task and therefore runs continuously.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image4.jpg" width="800px" alt="Flink Dashboard"/>
</center>
<br>
<h2 id="using-kibana-to-visualize-results">
  Using Kibana to Visualize Results
  <a class="anchor" href="#using-kibana-to-visualize-results">#</a>
</h2>
<p>Access Kibana at <a href="http://localhost:5601">http://localhost:5601</a>. First, configure an index pattern by clicking &ldquo;Management&rdquo; in the left-side toolbar and find &ldquo;Index Patterns&rdquo;. Next, click &ldquo;Create Index Pattern&rdquo; and enter the full index name <code>buy_cnt_per_hour</code> to create the index pattern. After creating the index pattern, we can explore data in Kibana.</p>
<div class="alert alert-info" markdown="1">
<span class="label label-info" style="display: inline-block"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Note </span>
Since we are using the TUMBLE window of one hour here, it might take about four minutes between the time that containers started and until the first row is emitted. Until then the index does not exist and Kibana is unable to find the index.
</div>
<p>Click &ldquo;Discover&rdquo; in the left-side toolbar. Kibana lists the content of the created index.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image5.jpg" width="800px" alt="Kibana Discover"/>
</center>
<br>
<p>Next, create a dashboard to display various views. Click &ldquo;Dashboard&rdquo; on the left side of the page to create a dashboard named &ldquo;User Behavior Analysis&rdquo;. Then, click &ldquo;Create New&rdquo; to create a new view. Select &ldquo;Area&rdquo; (area graph), then select the <code>buy_cnt_per_hour</code> index, and draw the trading volume area chart as illustrated in the configuration on the left side of the following diagram. Apply the changes by clicking the “▶” play button. Then, save it as &ldquo;Hourly Trading Volume&rdquo;.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image6.jpg" width="800px" alt="Hourly Trading Volume"/>
</center>
<br>
<p>You can see that during the early morning hours the number of transactions have the lowest value for the entire day.</p>
<p>As real-time data is added into the indices, you can enable auto-refresh in Kibana to see real-time visualization changes and updates. You can do so by clicking the time picker and entering a refresh interval (e.g. 3 seconds) in the “Refresh every” field.</p>
<h1 id="cumulative-number-of-unique-visitors-every-10-min">
  Cumulative number of Unique Visitors every 10-min
  <a class="anchor" href="#cumulative-number-of-unique-visitors-every-10-min">#</a>
</h1>
<p>Another interesting visualization is the cumulative number of unique visitors (UV). For example, the number of UV at 10:00 represents the total number of UV from 00:00 to 10:00. Therefore, the curve is monotonically increasing.</p>
<p>Let’s create another Elasticsearch table in the SQL CLI to store the UV results. This table contains 3 columns: date, time and cumulative UVs.
The <code>date_str</code> and <code>time_str</code> column are defined as primary key, Elasticsearch sink will use them to calculate the document ID and work in upsert mode to update UV values under the document ID.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cumulative_uv</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">date_str</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">time_str</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">uv</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span><span class="w"> </span><span class="n">time_str</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ENFORCED</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;connector&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;hosts&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;index&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cumulative_uv&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>We can extract the date and time using <code>DATE_FORMAT</code> function based on the <code>ts</code> field. As the section title describes, we only need to report every 10 minutes. So, we can use <code>SUBSTR</code> and the string concat function <code>||</code> to convert the time value into a 10-minute interval time string, such as <code>12:00</code>, <code>12:10</code>.
Next, we group data by <code>date_str</code> and perform a <code>COUNT DISTINCT</code> aggregation on <code>user_id</code> to get the current cumulative UV in this day. Additionally, we perform a <code>MAX</code> aggregation on <code>time_str</code> field to get the current stream time: the maximum event time observed so far.
As the maximum time is also a part of the primary key of the sink, the final result is that we will insert a new point into the elasticsearch every 10 minute. And every latest point will be updated continuously until the next 10-minute point is generated.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">cumulative_uv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">date_str</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">time_str</span><span class="p">),</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">uv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">date_str</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SUBSTR</span><span class="p">(</span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;HH:mm&#39;</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">time_str</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_behavior</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">date_str</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>After submitting this query, we create a <code>cumulative_uv</code> index pattern in Kibana. We then create a &ldquo;Line&rdquo; (line graph) on the dashboard, by selecting the <code>cumulative_uv</code> index, and drawing the cumulative UV curve according to the configuration on the left side of the following figure before finally saving the curve.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image7.jpg" width="800px" alt="Cumulative Unique Visitors every 10-min"/>
</center>
<br>
<h1 id="top-categories">
  Top Categories
  <a class="anchor" href="#top-categories">#</a>
</h1>
<p>The last visualization represents the category rankings to inform us on the most popular categories in our e-commerce site. Since our data source offers events for more than 5,000 categories without providing any additional significance to our analytics, we would like to reduce it so that it only includes the top-level categories. We will use the data in our MySQL database by joining it as a dimension table with our Kafka events to map sub-categories to top-level categories.</p>
<p>Create a table in the SQL CLI to make the data in MySQL accessible to Flink SQL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">category_dim</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub_category_id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">parent_category_name</span><span class="w"> </span><span class="n">STRING</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;connector&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;jdbc&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;url&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;jdbc:mysql://mysql:3306/flink&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;table-name&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;category&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;username&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;password&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;123456&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;lookup.cache.max-rows&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;5000&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;lookup.cache.ttl&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;10min&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>The underlying JDBC connector implements the <code>LookupTableSource</code> interface, so the created JDBC table <code>category_dim</code> can be used as a temporal table (i.e. lookup table) out-of-the-box in the data enrichment.</p>
<p>In addition, create an Elasticsearch table to store the category statistics.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">top_category</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">category_name</span><span class="w"> </span><span class="n">STRING</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ENFORCED</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">buy_cnt</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;connector&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;hosts&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;index&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;top_category&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>In order to enrich the category names, we use Flink SQL’s temporal table joins to join a dimension table. You can access more information about <a href="//nightlies.apache.org/flink/flink-docs-release-1.11/dev/table/streaming/joins.html#join-with-a-temporal-table">temporal joins</a> in the Flink documentation.</p>
<p>Additionally, we use the <code>CREATE VIEW</code> syntax to register the query as a logical view, allowing us to easily reference this query in subsequent queries and simplify nested queries. Please note that creating a logical view does not trigger the execution of the job and the view results are not persisted. Therefore, this statement is lightweight and does not have additional overhead.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">rich_user_behavior</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">item_id</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">behavior</span><span class="p">,</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">parent_category_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">category_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">user_behavior</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">category_dim</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">SYSTEM_TIME</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">proctime</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">C</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">U</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">sub_category_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Finally, we group the dimensional table by category name to count the number of <code>buy</code> events and write the result to Elasticsearch’s <code>top_category</code> index.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">top_category</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">category_name</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buy_cnt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">rich_user_behavior</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;buy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">category_name</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>After submitting the query, we create a <code>top_category</code> index pattern in Kibana. We then  create a &ldquo;Horizontal Bar&rdquo; (bar graph) on the dashboard, by selecting the <code>top_category</code> index and drawing the category ranking according to the configuration on the left side of the following diagram before finally saving the list.</p>
<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image8.jpg" width="800px" alt="Top Categories"/>
</center>
<br>
<p>As illustrated in the diagram, the categories of clothing and shoes exceed by far other categories on the e-commerce website.</p>
<hr>
<p>We have now implemented three practical applications and created charts for them. We can now return to the dashboard page and drag-and-drop each view to give our dashboard a more formal and intuitive style, as illustrated in the beginning of the blogpost. Of course, Kibana also provides a rich set of graphics and visualization features, and the user_behavior logs contain a lot more interesting information to explore. Using Flink SQL, you can analyze data in more dimensions, while using Kibana allows you to display more views and observe real-time changes in its charts!</p>
<h1 id="summary">
  Summary
  <a class="anchor" href="#summary">#</a>
</h1>
<p>In the previous sections, we described how to use Flink SQL to integrate Kafka, MySQL, Elasticsearch, and Kibana to quickly build a real-time analytics application. The entire process can be completed using standard SQL syntax, without a line of Java or Scala code. We hope that this article provides some clear and practical examples of the convenience and power of Flink SQL, featuring an easy connection to various external systems, native support for event time and out-of-order handling, dimension table joins and a wide range of built-in functions. We hope you have fun following the examples in this blogpost!</p>
</p>
</article>
 
      

      <footer class="book-footer">
        
  





<a href="https://cwiki.apache.org/confluence/display/FLINK/Flink+Translation+Specifications">Want to contribute translation?</a>
<br><br>
<a href="//github.com/apache/flink-web/edit/asf-site/docs/content/posts/2020-07-28-flink-sql-demo-building-e2e-streaming-application.md" style="color:black"><i class="fa fa-edit fa-fw"></i>Edit This Page</a>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      


<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#preparation">Preparation</a>
      <ul>
        <li><a href="#starting-the-demo-environment">Starting the Demo Environment</a></li>
        <li><a href="#entering-the-flink-sql-cli-client">Entering the Flink SQL CLI client</a></li>
        <li><a href="#creating-a-kafka-table-using-ddl">Creating a Kafka table using DDL</a></li>
      </ul>
    </li>
    <li><a href="#hourly-trading-volume">Hourly Trading Volume</a>
      <ul>
        <li><a href="#creating-an-elasticsearch-table-using-ddl">Creating an Elasticsearch table using DDL</a></li>
        <li><a href="#submitting-a-query">Submitting a Query</a></li>
        <li><a href="#using-kibana-to-visualize-results">Using Kibana to Visualize Results</a></li>
      </ul>
    </li>
    <li><a href="#cumulative-number-of-unique-visitors-every-10-min">Cumulative number of Unique Visitors every 10-min</a></li>
    <li><a href="#top-categories">Top Categories</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>

 
    </aside>
    <aside class="expand-toc">
      <button class="toc" onclick="expandToc()">
        <i class="fa fa-expand" aria-hidden="true"></i>
      </button>
    </aside>
    
  </main>

  
</body>

</html>












