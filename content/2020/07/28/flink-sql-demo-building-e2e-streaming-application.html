<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink: Flink SQL Demo: Building an End-to-End Streaming Application</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/flink.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Blog RSS feed -->
    <link href="/blog/feed.xml" rel="alternate" type="application/rss+xml" title="Apache Flink Blog: RSS feed" />

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- We need to load Jquery in the header for custom google analytics event tracking-->
    <script src="/js/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>  
    

    <!-- Main content. -->
    <div class="container">
    <div class="row">

      
     <div id="sidebar" class="col-sm-3">
        

<!-- Top navbar. -->
    <nav class="navbar navbar-default">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/">
              <img alt="Apache Flink" src="/img/flink-header-logo.svg" width="147px" height="73px">
            </a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-main">

            <!-- First menu section explains visitors what Flink is -->

            <!-- What is Stream Processing? -->
            <!--
            <li><a href="/streamprocessing1.html">What is Stream Processing?</a></li>
            -->

            <!-- What is Flink? -->
            <li><a href="/flink-architecture.html">What is Apache Flink?</a></li>

            
            <ul class="nav navbar-nav navbar-subnav">
              <li >
                  <a href="/flink-architecture.html">Architecture</a>
              </li>
              <li >
                  <a href="/flink-applications.html">Applications</a>
              </li>
              <li >
                  <a href="/flink-operations.html">Operations</a>
              </li>
            </ul>
            

            <!-- What is Stateful Functions? -->

            <li><a href="/stateful-functions.html">What is Stateful Functions?</a></li>

            <!-- Use cases -->
            <li><a href="/usecases.html">Use Cases</a></li>

            <!-- Powered by -->
            <li><a href="/poweredby.html">Powered By</a></li>


            &nbsp;
            <!-- Second menu section aims to support Flink users -->

            <!-- Downloads -->
            <li><a href="/downloads.html">Downloads</a></li>

            <!-- Getting Started -->
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Getting Started<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/index.html" target="_blank">With Flink <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
                <li><a href="https://ci.apache.org/projects/flink/flink-statefun-docs-release-2.2/getting-started/project-setup.html" target="_blank">With Flink Stateful Functions <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
                <li><a href="/training.html">Training Course</a></li>
              </ul>
            </li>

            <!-- Documentation -->
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Documentation<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12" target="_blank">Flink 1.12 (Latest stable release) <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
                <li><a href="https://ci.apache.org/projects/flink/flink-docs-master" target="_blank">Flink Master (Latest Snapshot) <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
                <li><a href="https://ci.apache.org/projects/flink/flink-statefun-docs-release-2.2" target="_blank">Flink Stateful Functions 2.2 (Latest stable release) <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
                <li><a href="https://ci.apache.org/projects/flink/flink-statefun-docs-master" target="_blank">Flink Stateful Functions Master (Latest Snapshot) <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>
              </ul>
            </li>

            <!-- getting help -->
            <li><a href="/gettinghelp.html">Getting Help</a></li>

            <!-- Blog -->
            <li><a href="/blog/"><b>Flink Blog</b></a></li>


            <!-- Flink-packages -->
            <li>
              <a href="https://flink-packages.org" target="_blank">flink-packages.org <small><span class="glyphicon glyphicon-new-window"></span></small></a>
            </li>
            &nbsp;

            <!-- Third menu section aim to support community and contributors -->

            <!-- Community -->
            <li><a href="/community.html">Community &amp; Project Info</a></li>

            <!-- Roadmap -->
            <li><a href="/roadmap.html">Roadmap</a></li>

            <!-- Contribute -->
            <li><a href="/contributing/how-to-contribute.html">How to Contribute</a></li>
            

            <!-- GitHub -->
            <li>
              <a href="https://github.com/apache/flink" target="_blank">Flink on GitHub <small><span class="glyphicon glyphicon-new-window"></span></small></a>
            </li>

            &nbsp;

            <!-- Language Switcher -->
            <li>
              
                
                  <a href="/zh/2020/07/28/flink-sql-demo-building-e2e-streaming-application.html">中文版</a>
                
              
            </li>

          </ul>

          <ul class="nav navbar-nav navbar-bottom">
          <hr />

            <!-- Twitter -->
            <li><a href="https://twitter.com/apacheflink" target="_blank">@ApacheFlink <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>

            <!-- Visualizer -->
            <li class=" hidden-md hidden-sm"><a href="/visualizer/" target="_blank">Plan Visualizer <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>

          <hr />

            <li><a href="https://apache.org" target="_blank">Apache Software Foundation <small><span class="glyphicon glyphicon-new-window"></span></small></a></li>

            <li>
              <style>
                .smalllinks:link {
                  display: inline-block !important; background: none; padding-top: 0px; padding-bottom: 0px; padding-right: 0px; min-width: 75px;
                }
              </style>

              <a class="smalllinks" href="https://www.apache.org/licenses/" target="_blank">License</a> <small><span class="glyphicon glyphicon-new-window"></span></small>

              <a class="smalllinks" href="https://www.apache.org/security/" target="_blank">Security</a> <small><span class="glyphicon glyphicon-new-window"></span></small>

              <a class="smalllinks" href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Donate</a> <small><span class="glyphicon glyphicon-new-window"></span></small>

              <a class="smalllinks" href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a> <small><span class="glyphicon glyphicon-new-window"></span></small>
            </li>

          </ul>
        </div><!-- /.navbar-collapse -->
    </nav>

      </div>
      <div class="col-sm-9">
      <div class="row-fluid">
  <div class="col-sm-12">
    <div class="row">
      <h1>Flink SQL Demo: Building an End-to-End Streaming Application</h1>
      <p><i></i></p>

      <article>
        <p>28 Jul 2020 Jark Wu (<a href="https://twitter.com/JarkWu">@JarkWu</a>)</p>

<p>Apache Flink 1.11 has released many exciting new features, including many developments in Flink SQL which is evolving at a fast pace. This article takes a closer look at how to quickly build streaming applications with Flink SQL from a practical point of view.</p>

<p>In the following sections, we describe how to integrate Kafka, MySQL, Elasticsearch, and Kibana with Flink SQL to analyze e-commerce user behavior in real-time. All exercises in this blogpost are performed in the Flink SQL CLI, and the entire process uses standard SQL syntax, without a single line of Java/Scala code or IDE installation. The final result of this demo is shown in the following figure:</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image1.gif" width="650px" alt="Demo Overview" />
</center>
<p><br /></p>

<h1 id="preparation">Preparation</h1>

<p>Prepare a Linux or MacOS computer with Docker installed.</p>

<h2 id="starting-the-demo-environment">Starting the Demo Environment</h2>

<p>The components required in this demo are all managed in containers, so we will use <code>docker-compose</code> to start them. First, download the <code>docker-compose.yml</code> file that defines the demo environment, for example by running the following commands:</p>

<div class="highlight"><pre><code>mkdir flink-sql-demo; cd flink-sql-demo;
wget https://raw.githubusercontent.com/wuchong/flink-sql-demo/v1.11-EN/docker-compose.yml
</code></pre></div>

<p>The Docker Compose environment consists of the following containers:</p>

<ul>
  <li><strong>Flink SQL CLI:</strong> used to submit queries and visualize their results.</li>
  <li><strong>Flink Cluster:</strong> a Flink JobManager and a Flink TaskManager container to execute queries.</li>
  <li><strong>MySQL:</strong> MySQL 5.7 and a pre-populated <code>category</code> table in the database. The <code>category</code> table will be joined with data in Kafka to enrich the real-time data.</li>
  <li><strong>Kafka:</strong> mainly used as a data source. The DataGen component automatically writes data into a Kafka topic.</li>
  <li><strong>Zookeeper:</strong> this component is required by Kafka.</li>
  <li><strong>Elasticsearch:</strong> mainly used as a data sink.</li>
  <li><strong>Kibana:</strong> used to visualize the data in Elasticsearch.</li>
  <li><strong>DataGen:</strong> the data generator. After the container is started, user behavior data is automatically generated and sent to the Kafka topic. By default, 2000 data entries are generated each second for about 1.5 hours. You can modify DataGen’s <code>speedup</code> parameter in <code>docker-compose.yml</code> to adjust the generation rate (which takes effect after Docker Compose is restarted).</li>
</ul>

<div class="alert alert-danger">
  <p><span class="label label-danger" style="display: inline-block"> Note </span>
Before starting the containers, we recommend configuring Docker so that sufficient resources are available and the environment does not become unresponsive. We suggest running Docker at 3-4 GB memory and 3-4 CPU cores.</p>
</div>

<p>To start all containers, run the following command in the directory that contains the <code>docker-compose.yml</code> file.</p>

<div class="highlight"><pre><code>docker-compose up -d
</code></pre></div>

<p>This command automatically starts all the containers defined in the Docker Compose configuration in a detached mode. Run <code>docker ps</code> to check whether the 9 containers are running properly. You can also visit <a href="http://localhost:5601/">http://localhost:5601/</a> to see if Kibana is running normally.</p>

<p>Don’t forget to run the following command to stop all containers after you finished the tutorial:</p>

<div class="highlight"><pre><code>docker-compose down
</code></pre></div>

<h2 id="entering-the-flink-sql-cli-client">Entering the Flink SQL CLI client</h2>

<p>To enter the SQL CLI client run:</p>

<div class="highlight"><pre><code class="language-bash">docker-compose <span class="nb">exec </span>sql-client ./sql-client.sh</code></pre></div>

<p>The command starts the SQL CLI client in the container.
You should see the welcome screen of the CLI client.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image3.png" width="500px" alt="Flink SQL CLI welcome page" />
</center>
<p><br /></p>

<h2 id="creating-a-kafka-table-using-ddl">Creating a Kafka table using DDL</h2>

<p>The DataGen container continuously writes events into the Kafka <code>user_behavior</code> topic. This data contains the user behavior on the day of November 27, 2017 (behaviors include “click”, “like”, “purchase” and “add to shopping cart” events). Each row represents a user behavior event, with the user ID, product ID, product category ID, event type, and timestamp in JSON format. Note that the dataset is from the <a href="https://tianchi.aliyun.com/dataset/dataDetail?dataId=649">Alibaba Cloud Tianchi public dataset</a>.</p>

<p>In the directory that contains <code>docker-compose.yml</code>, run the following command to view the first 10 data entries generated in the Kafka topic:</p>

<div class="highlight"><pre><code>docker-compose exec kafka bash -c 'kafka-console-consumer.sh --topic user_behavior --bootstrap-server kafka:9094 --from-beginning --max-messages 10'

{"user_id": "952483", "item_id":"310884", "category_id": "4580532", "behavior": "pv", "ts": "2017-11-27T00:00:00Z"}
{"user_id": "794777", "item_id":"5119439", "category_id": "982926", "behavior": "pv", "ts": "2017-11-27T00:00:00Z"}
...
</code></pre></div>

<p>In order to make the events in the Kafka topic accessible to Flink SQL, we run the following DDL statement in SQL CLI to create a table that connects to the topic in the Kafka cluster:</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">user_behavior</span> <span class="p">(</span>
    <span class="n">user_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">item_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">category_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">behavior</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">ts</span> <span class="k">TIMESTAMP</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">proctime</span> <span class="k">AS</span> <span class="n">PROCTIME</span><span class="p">(),</span>   <span class="c1">-- generates processing-time attribute using computed column</span>
    <span class="n">WATERMARK</span> <span class="k">FOR</span> <span class="n">ts</span> <span class="k">AS</span> <span class="n">ts</span> <span class="o">-</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;5&#39;</span> <span class="k">SECOND</span>  <span class="c1">-- defines watermark on ts column, marks ts as event-time attribute</span>
<span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;kafka&#39;</span><span class="p">,</span>  <span class="c1">-- using kafka connector</span>
    <span class="s1">&#39;topic&#39;</span> <span class="o">=</span> <span class="s1">&#39;user_behavior&#39;</span><span class="p">,</span>  <span class="c1">-- kafka topic</span>
    <span class="s1">&#39;scan.startup.mode&#39;</span> <span class="o">=</span> <span class="s1">&#39;earliest-offset&#39;</span><span class="p">,</span>  <span class="c1">-- reading from the beginning</span>
    <span class="s1">&#39;properties.bootstrap.servers&#39;</span> <span class="o">=</span> <span class="s1">&#39;kafka:9094&#39;</span><span class="p">,</span>  <span class="c1">-- kafka broker address</span>
    <span class="s1">&#39;format&#39;</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>  <span class="c1">-- the data format is json</span>
<span class="p">);</span></code></pre></div>

<p>The above snippet declares five fields based on the data format. In addition, it uses the computed column syntax and built-in <code>PROCTIME()</code> function to declare a virtual column that generates the processing-time attribute. It also uses the <code>WATERMARK</code> syntax to declare the watermark strategy on the <code>ts</code> field (tolerate 5-seconds out-of-order). Therefore, the <code>ts</code> field becomes an event-time attribute. For more information about time attributes and DDL syntax, see the following official documents:</p>

<ul>
  <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/streaming/time_attributes.html">Time attributes in Flink’s Table API &amp; SQL</a></li>
  <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/sql/create.html#create-table">DDL Syntax in Flink SQL</a></li>
</ul>

<p>After creating the <code>user_behavior</code> table in the SQL CLI, run <code>SHOW TABLES;</code> and <code>DESCRIBE user_behavior;</code> to see registered tables and table details. Also, run the command <code>SELECT * FROM user_behavior;</code> directly in the SQL CLI to preview the data (press <code>q</code> to exit).</p>

<p>Next, we discover more about Flink SQL through three real-world scenarios.</p>

<h1 id="hourly-trading-volume">Hourly Trading Volume</h1>

<h2 id="creating-an-elasticsearch-table-using-ddl">Creating an Elasticsearch table using DDL</h2>

<p>Let’s create an Elasticsearch result table in the SQL CLI. We need two columns in this case: <code>hour_of_day</code> and <code>buy_cnt</code> (trading volume).</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">buy_cnt_per_hour</span> <span class="p">(</span>
    <span class="n">hour_of_day</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">buy_cnt</span> <span class="nb">BIGINT</span>
<span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span> <span class="c1">-- using elasticsearch connector</span>
    <span class="s1">&#39;hosts&#39;</span> <span class="o">=</span> <span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span>  <span class="c1">-- elasticsearch address</span>
    <span class="s1">&#39;index&#39;</span> <span class="o">=</span> <span class="s1">&#39;buy_cnt_per_hour&#39;</span>  <span class="c1">-- elasticsearch index name, similar to database table name</span>
<span class="p">);</span></code></pre></div>

<p>There is no need to create the <code>buy_cnt_per_hour</code> index in Elasticsearch in advance since Elasticsearch will automatically create the index if it does not exist.</p>

<h2 id="submitting-a-query">Submitting a Query</h2>

<p>The hourly trading volume is the number of “buy” behaviors completed each hour. Therefore, we can use a <code>TUMBLE</code> window function to assign data into hourly windows. Then, we count the number of “buy” records in each window. To implement this, we can filter out the “buy” data first and then apply <code>COUNT(*)</code>.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">buy_cnt_per_hour</span>
<span class="k">SELECT</span> <span class="n">HOUR</span><span class="p">(</span><span class="n">TUMBLE_START</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;1&#39;</span> <span class="n">HOUR</span><span class="p">)),</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">user_behavior</span>
<span class="k">WHERE</span> <span class="n">behavior</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">TUMBLE</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;1&#39;</span> <span class="n">HOUR</span><span class="p">);</span></code></pre></div>

<p>Here, we use the built-in <code>HOUR</code> function to extract the value for each hour in the day from a <code>TIMESTAMP</code> column. Use <code>INSERT INTO</code> to start a Flink SQL job that continuously writes results into the Elasticsearch <code>buy_cnt_per_hour</code> index. The Elasticearch result table can be seen as a materialized view of the query. You can find more information about Flink’s window aggregation in the <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/sql/queries.html#group-windows">Apache Flink documentation</a>.</p>

<p>After running the previous query in the Flink SQL CLI, we can observe the submitted task on the <a href="http://localhost:8081">Flink Web UI</a>. This task is a streaming task and therefore runs continuously.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image4.jpg" width="800px" alt="Flink Dashboard" />
</center>
<p><br /></p>

<h2 id="using-kibana-to-visualize-results">Using Kibana to Visualize Results</h2>

<p>Access Kibana at <a href="http://localhost:5601">http://localhost:5601</a>. First, configure an index pattern by clicking “Management” in the left-side toolbar and find “Index Patterns”. Next, click “Create Index Pattern” and enter the full index name <code>buy_cnt_per_hour</code> to create the index pattern. After creating the index pattern, we can explore data in Kibana.</p>

<div class="alert alert-info">
  <p><span class="label label-info" style="display: inline-block"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Note </span>
Since we are using the TUMBLE window of one hour here, it might take about four minutes between the time that containers started and until the first row is emitted. Until then the index does not exist and Kibana is unable to find the index.</p>
</div>

<p>Click “Discover” in the left-side toolbar. Kibana lists the content of the created index.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image5.jpg" width="800px" alt="Kibana Discover" />
</center>
<p><br /></p>

<p>Next, create a dashboard to display various views. Click “Dashboard” on the left side of the page to create a dashboard named “User Behavior Analysis”. Then, click “Create New” to create a new view. Select “Area” (area graph), then select the <code>buy_cnt_per_hour</code> index, and draw the trading volume area chart as illustrated in the configuration on the left side of the following diagram. Apply the changes by clicking the “▶” play button. Then, save it as “Hourly Trading Volume”.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image6.jpg" width="800px" alt="Hourly Trading Volume" />
</center>
<p><br /></p>

<p>You can see that during the early morning hours the number of transactions have the lowest value for the entire day.</p>

<p>As real-time data is added into the indices, you can enable auto-refresh in Kibana to see real-time visualization changes and updates. You can do so by clicking the time picker and entering a refresh interval (e.g. 3 seconds) in the “Refresh every” field.</p>

<h1 id="cumulative-number-of-unique-visitors-every-10-min">Cumulative number of Unique Visitors every 10-min</h1>

<p>Another interesting visualization is the cumulative number of unique visitors (UV). For example, the number of UV at 10:00 represents the total number of UV from 00:00 to 10:00. Therefore, the curve is monotonically increasing.</p>

<p>Let’s create another Elasticsearch table in the SQL CLI to store the UV results. This table contains 3 columns: date, time and cumulative UVs.
The <code>date_str</code> and <code>time_str</code> column are defined as primary key, Elasticsearch sink will use them to calculate the document ID and work in upsert mode to update UV values under the document ID.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cumulative_uv</span> <span class="p">(</span>
    <span class="n">date_str</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">time_str</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">uv</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span><span class="p">)</span> <span class="k">NOT</span> <span class="n">ENFORCED</span>
<span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hosts&#39;</span> <span class="o">=</span> <span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span>
    <span class="s1">&#39;index&#39;</span> <span class="o">=</span> <span class="s1">&#39;cumulative_uv&#39;</span>
<span class="p">);</span></code></pre></div>

<p>We can extract the date and time using <code>DATE_FORMAT</code> function based on the <code>ts</code> field. As the section title describes, we only need to report every 10 minutes. So, we can use <code>SUBSTR</code> and the string concat function <code>||</code> to convert the time value into a 10-minute interval time string, such as <code>12:00</code>, <code>12:10</code>.
Next, we group data by <code>date_str</code> and perform a <code>COUNT DISTINCT</code> aggregation on <code>user_id</code> to get the current cumulative UV in this day. Additionally, we perform a <code>MAX</code> aggregation on <code>time_str</code> field to get the current stream time: the maximum event time observed so far.
As the maximum time is also a part of the primary key of the sink, the final result is that we will insert a new point into the elasticsearch every 10 minute. And every latest point will be updated continuously until the next 10-minute point is generated.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">cumulative_uv</span>
<span class="k">SELECT</span> <span class="n">date_str</span><span class="p">,</span> <span class="k">MAX</span><span class="p">(</span><span class="n">time_str</span><span class="p">),</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">uv</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">date_str</span><span class="p">,</span>
    <span class="n">SUBSTR</span><span class="p">(</span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;HH:mm&#39;</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;0&#39;</span> <span class="k">as</span> <span class="n">time_str</span><span class="p">,</span>
    <span class="n">user_id</span>
  <span class="k">FROM</span> <span class="n">user_behavior</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">date_str</span><span class="p">;</span></code></pre></div>

<p>After submitting this query, we create a <code>cumulative_uv</code> index pattern in Kibana. We then create a “Line” (line graph) on the dashboard, by selecting the <code>cumulative_uv</code> index, and drawing the cumulative UV curve according to the configuration on the left side of the following figure before finally saving the curve.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image7.jpg" width="800px" alt="Cumulative Unique Visitors every 10-min" />
</center>
<p><br /></p>

<h1 id="top-categories">Top Categories</h1>

<p>The last visualization represents the category rankings to inform us on the most popular categories in our e-commerce site. Since our data source offers events for more than 5,000 categories without providing any additional significance to our analytics, we would like to reduce it so that it only includes the top-level categories. We will use the data in our MySQL database by joining it as a dimension table with our Kafka events to map sub-categories to top-level categories.</p>

<p>Create a table in the SQL CLI to make the data in MySQL accessible to Flink SQL.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">category_dim</span> <span class="p">(</span>
    <span class="n">sub_category_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">parent_category_name</span> <span class="n">STRING</span>
<span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;jdbc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;url&#39;</span> <span class="o">=</span> <span class="s1">&#39;jdbc:mysql://mysql:3306/flink&#39;</span><span class="p">,</span>
    <span class="s1">&#39;table-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lookup.cache.max-rows&#39;</span> <span class="o">=</span> <span class="s1">&#39;5000&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lookup.cache.ttl&#39;</span> <span class="o">=</span> <span class="s1">&#39;10min&#39;</span>
<span class="p">);</span></code></pre></div>

<p>The underlying JDBC connector implements the <code>LookupTableSource</code> interface, so the created JDBC table <code>category_dim</code> can be used as a temporal table (i.e. lookup table) out-of-the-box in the data enrichment.</p>

<p>In addition, create an Elasticsearch table to store the category statistics.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">top_category</span> <span class="p">(</span>
    <span class="n">category_name</span> <span class="n">STRING</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="k">NOT</span> <span class="n">ENFORCED</span><span class="p">,</span>
    <span class="n">buy_cnt</span> <span class="nb">BIGINT</span>
<span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hosts&#39;</span> <span class="o">=</span> <span class="s1">&#39;http://elasticsearch:9200&#39;</span><span class="p">,</span>
    <span class="s1">&#39;index&#39;</span> <span class="o">=</span> <span class="s1">&#39;top_category&#39;</span>
<span class="p">);</span></code></pre></div>

<p>In order to enrich the category names, we use Flink SQL’s temporal table joins to join a dimension table. You can access more information about <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/streaming/joins.html#join-with-a-temporal-table">temporal joins</a> in the Flink documentation.</p>

<p>Additionally, we use the <code>CREATE VIEW</code> syntax to register the query as a logical view, allowing us to easily reference this query in subsequent queries and simplify nested queries. Please note that creating a logical view does not trigger the execution of the job and the view results are not persisted. Therefore, this statement is lightweight and does not have additional overhead.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">rich_user_behavior</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">U</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">U</span><span class="p">.</span><span class="n">item_id</span><span class="p">,</span> <span class="n">U</span><span class="p">.</span><span class="n">behavior</span><span class="p">,</span> <span class="k">C</span><span class="p">.</span><span class="n">parent_category_name</span> <span class="k">as</span> <span class="n">category_name</span>
<span class="k">FROM</span> <span class="n">user_behavior</span> <span class="k">AS</span> <span class="n">U</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">category_dim</span> <span class="k">FOR</span> <span class="n">SYSTEM_TIME</span> <span class="k">AS</span> <span class="k">OF</span> <span class="n">U</span><span class="p">.</span><span class="n">proctime</span> <span class="k">AS</span> <span class="k">C</span>
<span class="k">ON</span> <span class="n">U</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="k">C</span><span class="p">.</span><span class="n">sub_category_id</span><span class="p">;</span></code></pre></div>

<p>Finally, we group the dimensional table by category name to count the number of <code>buy</code> events and write the result to Elasticsearch’s <code>top_category</code> index.</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">top_category</span>
<span class="k">SELECT</span> <span class="n">category_name</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">buy_cnt</span>
<span class="k">FROM</span> <span class="n">rich_user_behavior</span>
<span class="k">WHERE</span> <span class="n">behavior</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">category_name</span><span class="p">;</span></code></pre></div>

<p>After submitting the query, we create a <code>top_category</code> index pattern in Kibana. We then  create a “Horizontal Bar” (bar graph) on the dashboard, by selecting the <code>top_category</code> index and drawing the category ranking according to the configuration on the left side of the following diagram before finally saving the list.</p>

<center>
<img src="/img/blog/2020-07-28-flink-sql-demo/image8.jpg" width="800px" alt="Top Categories" />
</center>
<p><br /></p>

<p>As illustrated in the diagram, the categories of clothing and shoes exceed by far other categories on the e-commerce website.</p>

<hr />

<p>We have now implemented three practical applications and created charts for them. We can now return to the dashboard page and drag-and-drop each view to give our dashboard a more formal and intuitive style, as illustrated in the beginning of the blogpost. Of course, Kibana also provides a rich set of graphics and visualization features, and the user_behavior logs contain a lot more interesting information to explore. Using Flink SQL, you can analyze data in more dimensions, while using Kibana allows you to display more views and observe real-time changes in its charts!</p>

<h1 id="summary">Summary</h1>

<p>In the previous sections, we described how to use Flink SQL to integrate Kafka, MySQL, Elasticsearch, and Kibana to quickly build a real-time analytics application. The entire process can be completed using standard SQL syntax, without a line of Java or Scala code. We hope that this article provides some clear and practical examples of the convenience and power of Flink SQL, featuring an easy connection to various external systems, native support for event time and out-of-order handling, dimension table joins and a wide range of built-in functions. We hope you have fun following the examples in this blogpost!</p>

      </article>
    </div>

    <div class="row">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'stratosphere-eu'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
  </div>
</div>
      </div>
    </div>

    <hr />

    <div class="row">
      <div class="footer text-center col-sm-12">
        <p>Copyright © 2014-2019 <a href="http://apache.org">The Apache Software Foundation</a>. All Rights Reserved.</p>
        <p>Apache Flink, Flink®, Apache®, the squirrel logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation.</p>
        <p><a href="/privacy-policy.html">Privacy Policy</a> &middot; <a href="/blog/feed.xml">RSS feed</a></p>
      </div>
    </div>
    </div><!-- /.container -->

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.matchHeight/0.7.0/jquery.matchHeight-min.js"></script>
    <script src="/js/codetabs.js"></script>
    <script src="/js/stickysidebar.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
